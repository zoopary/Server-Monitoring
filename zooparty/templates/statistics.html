<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ lang.statistical_analysis }} - ÊúçÂä°Âô®ÁõëÊéßÁ≥ªÁªü</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .navbar-brand {
            font-weight: 600;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 1.5rem;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            font-weight: 600;
            padding: 1rem 1.25rem;
            border-radius: 12px 12px 0 0 !important;
        }
        
        .control-panel {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .chart-container {
            height: 400px;
            border-radius: 10px;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .stat-trend {
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .trend-up {
            color: var(--danger-color);
        }
        
        .trend-down {
            color: var(--success-color);
        }
        
        .comparison-chart {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .no-data {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .language-switcher {
            margin-left: 15px;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .language-switcher {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-graph-up"></i> ÊúçÂä°Âô®ÁõëÊéßÁ≥ªÁªü
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-speedometer2"></i> {{ lang.nav_dashboard }}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/alerts">
                            <i class="bi bi-bell"></i> {{ lang.nav_alerts }}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history">
                            <i class="bi bi-clock-history"></i> {{ lang.nav_history }}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/statistics">
                            <i class="bi bi-graph-up-arrow"></i> {{ lang.nav_statistics }}
                        </a>
                    </li>
                </ul>
                <div class="navbar-text d-flex align-items-center">
                    <div class="language-switcher">
                        <div class="btn-group">
                            <a href="/set_language/zh" class="btn btn-sm {{ 'btn-primary' if language == 'zh' else 'btn-outline-primary' }}">‰∏≠Êñá</a>
                            <a href="/set_language/en" class="btn btn-sm {{ 'btn-primary' if language == 'en' else 'btn-outline-primary' }}">English</a>
                        </div>
                    </div>
                    <span class="ms-3">
                        <i class="bi bi-clock"></i> <span id="currentTime">--:--:--</span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- È°µÈù¢Ê†áÈ¢ò -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-graph-up-arrow text-primary"></i> {{ lang.statistical_analysis }}</h1>
            <button class="btn btn-outline-primary" onclick="loadStatistics()">
                <i class="bi bi-arrow-clockwise"></i> {{ lang.refresh }}
            </button>
        </div>

        <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="control-panel">
            <h4 class="mb-3"><i class="bi bi-search"></i> {{ lang.analysis_conditions }}</h4>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="hostSelect" class="form-label">{{ lang.select_server }}</label>
                    <select class="form-select" id="hostSelect">
                        <option value="">{{ lang.select_server_placeholder }}</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="timeRange" class="form-label">{{ lang.analysis_period }}</label>
                    <select class="form-select" id="timeRange">
                        <option value="1">{{ lang.last_1_day }}</option>
                        <option value="3">{{ lang.last_3_days }}</option>
                        <option value="7" selected>{{ lang.last_7_days }}</option>
                        <option value="30">{{ lang.last_30_days }}</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="metricType" class="form-label">{{ lang.metric_type }}</label>
                    <select class="form-select" id="metricType">
                        <option value="both" selected>{{ lang.both_cpu_memory }}</option>
                        <option value="cpu">{{ lang.cpu_only }}</option>
                        <option value="memory">{{ lang.memory_only }}</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="loadStatistics()">
                    <i class="bi bi-calculator"></i> {{ lang.generate_report }}
                </button>
                <button class="btn btn-success ms-2" onclick="exportReport()">
                    <i class="bi bi-download"></i> {{ lang.export_report }}
                </button>
            </div>
        </div>

        <!-- ÁªüËÆ°Ê¶ÇËßà -->
        <div class="stats-grid" id="statsOverview" style="display: none;">
            <!-- Âä®ÊÄÅÁîüÊàêÁªüËÆ°Âç°Áâá -->
        </div>

        <!-- ËØ¶ÁªÜÁªüËÆ°ÂõæË°® -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart-line"></i> {{ lang.detailed_statistical_analysis }}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div id="statsChart" class="chart-container"></div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div id="distributionChart" class="chart-container"></div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div id="trendChart" class="chart-container"></div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div id="comparisonChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Êï∞ÊçÆË°®Ê†º -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-table"></i> {{ lang.statistical_details }}
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <div id="statsTable">
                        <!-- Âä®ÊÄÅÂä†ËΩΩÁªüËÆ°Ë°®Ê†º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ÂàùÂßãÂåñÂõæË°®
        const statsChart = echarts.init(document.getElementById('statsChart'));
        const distributionChart = echarts.init(document.getElementById('distributionChart'));
        const trendChart = echarts.init(document.getElementById('trendChart'));
        const comparisonChart = echarts.init(document.getElementById('comparisonChart'));

        // ÂõæË°®ÈÖçÁΩÆ
        const chartOptions = {
            stats: {
                title: { 
                    text: '{{ lang.resource_usage_statistics }}', 
                    left: 'center',
                    textStyle: {
                        fontSize: 14,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['{{ lang.cpu_usage }}', '{{ lang.memory_usage }}'],
                    top: '10%'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '20%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['{{ lang.average_value }}', '{{ lang.maximum_value }}', '{{ lang.minimum_value }}', '{{ lang.median_value }}']
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [
                    {
                        name: '{{ lang.cpu_usage }}',
                        type: 'bar',
                        data: [],
                        itemStyle: {
                            color: '#3498db'
                        }
                    },
                    {
                        name: '{{ lang.memory_usage }}',
                        type: 'bar',
                        data: [],
                        itemStyle: {
                            color: '#27ae60'
                        }
                    }
                ]
            },
            distribution: {
                title: { 
                    text: '{{ lang.usage_distribution }}', 
                    left: 'center',
                    textStyle: {
                        fontSize: 14,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['{{ lang.cpu }}', '{{ lang.memory }}'],
                    top: '10%'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '20%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['0-20%', '20-40%', '40-60%', '60-80%', '80-100%']
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        name: '{{ lang.cpu }}',
                        type: 'line',
                        smooth: true,
                        data: [],
                        itemStyle: {
                            color: '#3498db'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(52, 152, 219, 0.3)' },
                                    { offset: 1, color: 'rgba(52, 152, 219, 0.1)' }
                                ]
                            }
                        }
                    },
                    {
                        name: '{{ lang.memory }}',
                        type: 'line',
                        smooth: true,
                        data: [],
                        itemStyle: {
                            color: '#27ae60'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(39, 174, 96, 0.3)' },
                                    { offset: 1, color: 'rgba(39, 174, 96, 0.1)' }
                                ]
                            }
                        }
                    }
                ]
            },
            trend: {
                title: { 
                    text: '{{ lang.hourly_trend_analysis }}', 
                    left: 'center',
                    textStyle: {
                        fontSize: 14,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['{{ lang.avg_cpu }}', '{{ lang.avg_memory }}', '{{ lang.max_cpu }}', '{{ lang.max_memory }}'],
                    top: '10%'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '20%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: []
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                dataZoom: [{
                    type: 'inside',
                    start: 0,
                    end: 100
                }],
                series: [
                    {
                        name: '{{ lang.avg_cpu }}',
                        type: 'line',
                        smooth: true,
                        data: [],
                        itemStyle: {
                            color: '#3498db'
                        }
                    },
                    {
                        name: '{{ lang.avg_memory }}',
                        type: 'line',
                        smooth: true,
                        data: [],
                        itemStyle: {
                            color: '#27ae60'
                        }
                    },
                    {
                        name: '{{ lang.max_cpu }}',
                        type: 'line',
                        smooth: true,
                        data: [],
                        itemStyle: {
                            color: '#e74c3c'
                        },
                        lineStyle: {
                            type: 'dashed'
                        }
                    },
                    {
                        name: '{{ lang.max_memory }}',
                        type: 'line',
                        smooth: true,
                        data: [],
                        itemStyle: {
                            color: '#f39c12'
                        },
                        lineStyle: {
                            type: 'dashed'
                        }
                    }
                ]
            },
            comparison: {
                title: { 
                    text: '{{ lang.performance_comparison_analysis }}', 
                    left: 'center',
                    textStyle: {
                        fontSize: 14,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                radar: {
                    indicator: [
                        { name: '{{ lang.avg_usage_rate }}', max: 100 },
                        { name: '{{ lang.peak_usage_rate }}', max: 100 },
                        { name: '{{ lang.stability }}', max: 100 },
                        { name: '{{ lang.load_variation }}', max: 100 },
                        { name: '{{ lang.alert_frequency }}', max: 100 }
                    ]
                },
                series: [{
                    type: 'radar',
                    data: []
                }]
            }
        };

        // Â∫îÁî®ÂõæË°®ÈÖçÁΩÆ
        statsChart.setOption(chartOptions.stats);
        distributionChart.setOption(chartOptions.distribution);
        trendChart.setOption(chartOptions.trend);
        comparisonChart.setOption(chartOptions.comparison);

        // Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }

        // Âä†ËΩΩ‰∏ªÊú∫ÂàóË°®
        function loadHosts() {
            fetch('/api/hosts')
                .then(response => response.json())
                .then(hosts => {
                    const select = document.getElementById('hostSelect');
                    select.innerHTML = '<option value="">{{ lang.select_server_placeholder }}</option>';
                    
                    hosts.forEach(host => {
                        const option = document.createElement('option');
                        option.value = host.ip;
                        option.textContent = `${host.ip} (${host.user})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('{{ lang.load_host_list_failed }}:', error));
        }

        // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
        function loadStatistics() {
            const hostIp = document.getElementById('hostSelect').value;
            const days = document.getElementById('timeRange').value;
            const metricType = document.getElementById('metricType').value;
            
            if (!hostIp) {
                showAlert('{{ lang.select_server_prompt }}', 'warning');
                return;
            }

            fetch(`/api/statistics/${hostIp}?days=${days}`)
                .then(response => response.json())
                .then(statsData => {
                    if (!statsData) {
                        showNoData();
                        return;
                    }
                    
                    updateStatsOverview(statsData.stats);
                    updateCharts(statsData, metricType);
                    updateStatsTable(statsData);
                })
                .catch(error => {
                    console.error('{{ lang.load_statistics_failed }}:', error);
                    showNoData();
                });
        }

        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.control-panel'));
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // ÊòæÁ§∫Êó†Êï∞ÊçÆÊèêÁ§∫
        function showNoData() {
            document.getElementById('statsOverview').style.display = 'none';
            document.getElementById('statsTable').innerHTML = `
                <div class="no-data">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">üì≠ {{ lang.no_statistics_data }}</h4>
                    <p class="text-muted">{{ lang.no_matching_statistics_data }}</p>
                </div>
            `;
            
            statsChart.setOption({ ...chartOptions.stats, series: [] });
            distributionChart.setOption({ ...chartOptions.distribution, series: [] });
            trendChart.setOption({ ...chartOptions.trend, series: [] });
            comparisonChart.setOption({ ...chartOptions.comparison, series: [] });
        }

        // Êõ¥Êñ∞ÁªüËÆ°Ê¶ÇËßà
        function updateStatsOverview(stats) {
            const container = document.getElementById('statsOverview');
            container.style.display = 'grid';
            
            const cards = [
                {
                    label: '{{ lang.avg_cpu_usage }}',
                    value: `${stats.cpu.avg}%`,
                    color: '#3498db',
                    trend: stats.cpu.avg > 80 ? 'high' : stats.cpu.avg > 60 ? 'medium' : 'low'
                },
                {
                    label: '{{ lang.max_cpu_usage }}',
                    value: `${stats.cpu.max}%`,
                    color: '#e74c3c',
                    trend: stats.cpu.max > 90 ? 'high' : stats.cpu.max > 80 ? 'medium' : 'low'
                },
                {
                    label: '{{ lang.avg_memory_usage }}',
                    value: `${stats.memory.avg}%`,
                    color: '#27ae60',
                    trend: stats.memory.avg > 80 ? 'high' : stats.memory.avg > 60 ? 'medium' : 'low'
                },
                {
                    label: '{{ lang.max_memory_usage }}',
                    value: `${stats.memory.max}%`,
                    color: '#f39c12',
                    trend: stats.memory.max > 90 ? 'high' : stats.memory.max > 80 ? 'medium' : 'low'
                },
                {
                    label: '{{ lang.data_points }}',
                    value: stats.cpu.count,
                    color: '#9b59b6',
                    trend: 'neutral'
                },
                {
                    label: '{{ lang.cpu_median }}',
                    value: `${stats.cpu.median}%`,
                    color: '#34495e',
                    trend: stats.cpu.median > 80 ? 'high' : stats.cpu.median > 60 ? 'medium' : 'low'
                }
            ];

            let html = '';
            cards.forEach(card => {
                const trendIcon = card.trend === 'high' ? 'bi-arrow-up' : 
                                card.trend === 'medium' ? 'bi-dash' : 
                                card.trend === 'low' ? 'bi-arrow-down' : 'bi-dash';
                const trendClass = card.trend === 'high' ? 'trend-up' : 
                                 card.trend === 'low' ? 'trend-down' : '';
                
                html += `
                    <div class="stat-card" style="border-left-color: ${card.color}">
                        <div class="stat-value" style="color: ${card.color}">${card.value}</div>
                        <div class="stat-label">${card.label}</div>
                        <div class="stat-trend ${trendClass}">
                            <i class="bi ${trendIcon}"></i>
                            ${card.trend === 'high' ? '{{ lang.high }}' : card.trend === 'medium' ? '{{ lang.medium }}' : card.trend === 'low' ? '{{ lang.low }}' : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Êõ¥Êñ∞ÂõæË°®
        function updateCharts(statsData, metricType) {
            const { stats, hourly_data } = statsData;

            // ÁªüËÆ°ÂõæË°®
            statsChart.setOption({
                series: [
                    {
                        data: [stats.cpu.avg, stats.cpu.max, stats.cpu.min, stats.cpu.median]
                    },
                    {
                        data: [stats.memory.avg, stats.memory.max, stats.memory.min, stats.memory.median]
                    }
                ]
            });

            // ÂàÜÂ∏ÉÂõæË°®ÔºàÊ®°ÊãüÊï∞ÊçÆÔºâ
            const cpuDistribution = [15, 25, 35, 20, 5]; // Ê®°ÊãüÂàÜÂ∏ÉÊï∞ÊçÆ
            const memoryDistribution = [20, 30, 25, 15, 10];
            
            distributionChart.setOption({
                series: [
                    {
                        data: metricType === 'memory' ? [] : cpuDistribution
                    },
                    {
                        data: metricType === 'cpu' ? [] : memoryDistribution
                    }
                ]
            });

            // Ë∂ãÂäøÂõæË°®
            const hours = hourly_data.map(item => item.hour.substring(11, 16)); // Âè™ÊòæÁ§∫Â∞èÊó∂:ÂàÜÈíü
            const avgCpuData = hourly_data.map(item => item.avg_cpu);
            const avgMemoryData = hourly_data.map(item => item.avg_memory);
            const maxCpuData = hourly_data.map(item => item.max_cpu);
            const maxMemoryData = hourly_data.map(item => item.max_memory);

            trendChart.setOption({
                xAxis: {
                    data: hours
                },
                series: [
                    {
                        data: metricType === 'memory' ? [] : avgCpuData
                    },
                    {
                        data: metricType === 'cpu' ? [] : avgMemoryData
                    },
                    {
                        data: metricType === 'memory' ? [] : maxCpuData
                    },
                    {
                        data: metricType === 'cpu' ? [] : maxMemoryData
                    }
                ]
            });

            // ÂØπÊØîÂàÜÊûêÂõæË°®
            comparisonChart.setOption({
                series: [{
                    data: [
                        {
                            value: [
                                (stats.cpu.avg + stats.memory.avg) / 2,
                                (stats.cpu.max + stats.memory.max) / 2,
                                100 - Math.abs(stats.cpu.avg - stats.memory.avg) * 2, // Á®≥ÂÆöÊÄß
                                Math.abs(stats.cpu.max - stats.cpu.min) / 2, // Ë¥üËΩΩÂèòÂåñ
                                100 - (stats.cpu.max > 90 ? 30 : stats.cpu.max > 80 ? 15 : 0) // ÂëäË≠¶È¢ëÁéá
                            ],
                            name: '{{ lang.performance_metrics }}'
                        }
                    ]
                }]
            });
        }

        // Êõ¥Êñ∞ÁªüËÆ°Ë°®Ê†º
        function updateStatsTable(statsData) {
            const { stats, period_days } = statsData;
            const table = document.getElementById('statsTable');
            
            let html = `
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>{{ lang.statistical_indicator }}</th>
                            <th>{{ lang.cpu_usage }}</th>
                            <th>{{ lang.memory_usage }}</th>
                            <th>{{ lang.description }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>{{ lang.average_value }}</strong></td>
                            <td class="${stats.cpu.avg > 80 ? 'text-danger fw-bold' : stats.cpu.avg > 60 ? 'text-warning' : 'text-success'}">${stats.cpu.avg}%</td>
                            <td class="${stats.memory.avg > 80 ? 'text-danger fw-bold' : stats.memory.avg > 60 ? 'text-warning' : 'text-success'}">${stats.memory.avg}%</td>
                            <td>{{ lang.average_usage_description }}</td>
                        </tr>
                        <tr>
                            <td><strong>{{ lang.maximum_value }}</strong></td>
                            <td class="${stats.cpu.max > 90 ? 'text-danger fw-bold' : stats.cpu.max > 80 ? 'text-warning' : 'text-primary'}">${stats.cpu.max}%</td>
                            <td class="${stats.memory.max > 90 ? 'text-danger fw-bold' : stats.memory.max > 80 ? 'text-warning' : 'text-primary'}">${stats.memory.max}%</td>
                            <td>{{ lang.peak_usage_description }}</td>
                        </tr>
                        <tr>
                            <td><strong>{{ lang.minimum_value }}</strong></td>
                            <td class="text-info">${stats.cpu.min}%</td>
                            <td class="text-info">${stats.memory.min}%</td>
                            <td>{{ lang.min_usage_description }}</td>
                        </tr>
                        <tr>
                            <td><strong>{{ lang.median_value }}</strong></td>
                            <td class="${stats.cpu.median > 80 ? 'text-danger fw-bold' : stats.cpu.median > 60 ? 'text-warning' : 'text-success'}">${stats.cpu.median}%</td>
                            <td class="${stats.memory.median > 80 ? 'text-danger fw-bold' : stats.memory.median > 60 ? 'text-warning' : 'text-success'}">${stats.memory.median}%</td>
                            <td>{{ lang.median_usage_description }}</td>
                        </tr>
                        <tr>
                            <td><strong>{{ lang.data_points }}</strong></td>
                            <td colspan="2" class="text-center">${stats.cpu.count} {{ lang.data_points_count }}</td>
                            <td>{{ lang.based_on_monitoring_data }}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> 
                    <strong>{{ lang.analysis_description }}Ôºö</strong> {{ lang.based_on_monitoring_data }} ${period_days} {{ lang.days_data }} ${stats.cpu.count} {{ lang.data_points_count }}„ÄÇ
                    ${stats.cpu.avg > 80 || stats.memory.avg > 80 ? '{{ lang.high_usage_detected }}' : '{{ lang.good_resource_usage }}'}
                </div>
            `;
            
            table.innerHTML = html;
        }

        // ÂØºÂá∫Êä•Âëä
        function exportReport() {
            const hostIp = document.getElementById('hostSelect').value;
            if (!hostIp) {
                showAlert('{{ lang.select_server_first }}', 'warning');
                return;
            }
            
            // ÂàõÂª∫ÊâìÂç∞Ê†∑Âºè
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>{{ lang.server_monitoring_statistical_report }}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                            .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
                            .stat-card { border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 5px; }
                            .stat-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f5f5f5; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>{{ lang.server_monitoring_statistical_report }}</h1>
                            <p>{{ lang.generation_time }}: ${new Date().toLocaleString()}</p>
                            <p>{{ lang.server }}: ${hostIp}</p>
                        </div>
                        <div id="reportContent">
                            ${document.getElementById('statsTable').innerHTML}
                        </div>
                        <div class="no-print" style="margin-top: 20px; text-align: center;">
                            <button onclick="window.print()">{{ lang.print_report }}</button>
                            <button onclick="window.close()">{{ lang.close }}</button>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Á™óÂè£Ë∞ÉÊï¥Â§ßÂ∞èÊó∂ÈáçÁªòÂõæË°®
        window.addEventListener('resize', function() {
            statsChart.resize();
            distributionChart.resize();
            trendChart.resize();
            comparisonChart.resize();
        });

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñÊó∂Èó¥
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // ÂàùÂßãÂåñÊï∞ÊçÆ
            loadHosts();
        });
    </script>
</body>
</html>